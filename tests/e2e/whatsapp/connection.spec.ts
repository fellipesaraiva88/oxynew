import { test, expect } from '@playwright/test';

test.describe('WhatsApp Connection - Dual Authentication Methods', () => {
  test.beforeEach(async ({ page }) => {
    // Login primeiro
    await page.goto('https://oxy-frontend-d84c.onrender.com/login');
    await page.getByRole('textbox', { name: /email/i }).fill('test@petshop.com');
    await page.getByRole('textbox', { name: /senha/i }).fill('Test@123');
    await page.getByRole('button', { name: /entrar/i }).click();

    // Aguardar dashboard carregar
    await page.waitForURL(/.*\/dashboard/, { timeout: 10000 });

    // Navegar para p√°gina de WhatsApp
    await page.goto('https://oxy-frontend-d84c.onrender.com/whatsapp');
    await page.waitForLoadState('networkidle');
  });

  test('P√°gina WhatsApp deve exibir wizard de configura√ß√£o', async ({ page }) => {
    // Verificar t√≠tulo principal
    await expect(page.getByRole('heading', { name: /conectar whatsapp/i })).toBeVisible();

    // Verificar que est√° no passo inicial
    await expect(page.getByText(/m√©todo.*conex√£o/i)).toBeVisible();
  });

  test('Ambos os m√©todos de autentica√ß√£o devem estar vis√≠veis', async ({ page }) => {
    // Verificar que ambos os bot√µes de m√©todo est√£o presentes
    await expect(page.getByRole('button', { name: /pairing code/i })).toBeVisible();
    await expect(page.getByRole('button', { name: /qr code/i })).toBeVisible();

    // Verificar emojis
    await expect(page.locator('text=üî¢')).toBeVisible();
    await expect(page.locator('text=üì±')).toBeVisible();

    // Verificar descri√ß√µes
    await expect(page.getByText(/c√≥digo.*8 d√≠gitos/i)).toBeVisible();
    await expect(page.getByText(/escanear.*c√¢mera/i)).toBeVisible();
  });

  test('Pairing Code deve ser selecionado por padr√£o', async ({ page }) => {
    // Verificar que Pairing Code est√° com estilo ativo (border-ocean-blue)
    const pairingButton = page.getByRole('button', { name: /pairing code/i });

    const buttonClasses = await pairingButton.getAttribute('class');
    expect(buttonClasses).toContain('border-ocean-blue');
  });

  test('Clicar em QR Code deve alternar sele√ß√£o', async ({ page }) => {
    const qrButton = page.getByRole('button', { name: /qr code/i });

    // Clicar em QR Code
    await qrButton.click();

    // Verificar que QR Code agora est√° ativo
    const buttonClasses = await qrButton.getAttribute('class');
    expect(buttonClasses).toContain('border-ocean-blue');
  });

  test('Campo de telefone deve estar vis√≠vel APENAS com Pairing Code', async ({ page }) => {
    // Com Pairing Code (padr√£o), campo deve estar vis√≠vel
    const phoneField = page.locator('input[placeholder*="n√∫mero"]').or(page.getByRole('textbox').filter({ hasText: /whatsapp/i }));
    await expect(phoneField).toBeVisible();

    // Alternar para QR Code
    await page.getByRole('button', { name: /qr code/i }).click();

    // Campo de telefone deve desaparecer
    await expect(phoneField).not.toBeVisible();

    // Voltar para Pairing Code
    await page.getByRole('button', { name: /pairing code/i }).click();

    // Campo deve reaparecer
    await expect(phoneField).toBeVisible();
  });

  test('Pairing Code: bot√£o "Gerar C√≥digo" deve estar desabilitado sem n√∫mero', async ({ page }) => {
    // Certificar que Pairing Code est√° selecionado
    await page.getByRole('button', { name: /pairing code/i }).click();

    // Bot√£o de avan√ßar/gerar deve estar desabilitado
    const submitButton = page.getByRole('button', { name: /gerar|continuar|pr√≥ximo/i });
    await expect(submitButton).toBeDisabled();
  });

  test('Pairing Code: preencher n√∫mero v√°lido deve habilitar bot√£o', async ({ page }) => {
    // Certificar que Pairing Code est√° selecionado
    await page.getByRole('button', { name: /pairing code/i }).click();

    // Preencher n√∫mero de telefone
    const phoneInput = page.locator('input[placeholder*="n√∫mero"]').or(page.getByRole('textbox').filter({ hasText: /whatsapp/i }));
    await phoneInput.fill('+5511999887766');

    // Bot√£o deve estar habilitado
    const submitButton = page.getByRole('button', { name: /gerar|continuar|pr√≥ximo/i });
    await expect(submitButton).toBeEnabled();
  });

  test('QR Code: bot√£o "Gerar QR Code" deve estar habilitado sem n√∫mero', async ({ page }) => {
    // Alternar para QR Code
    await page.getByRole('button', { name: /qr code/i }).click();

    // Bot√£o deve estar habilitado imediatamente (n√£o precisa de n√∫mero)
    const submitButton = page.getByRole('button', { name: /gerar|continuar|pr√≥ximo/i });
    await expect(submitButton).toBeEnabled();
  });

  test('Pairing Code: submeter formul√°rio deve gerar c√≥digo de 8 d√≠gitos', async ({ page }) => {
    // Selecionar Pairing Code
    await page.getByRole('button', { name: /pairing code/i }).click();

    // Preencher telefone
    const phoneInput = page.locator('input[placeholder*="n√∫mero"]').or(page.getByRole('textbox').filter({ hasText: /whatsapp/i }));
    await phoneInput.fill('+5511999887766');

    // Clicar em gerar c√≥digo
    await page.getByRole('button', { name: /gerar|continuar|pr√≥ximo/i }).click();

    // Aguardar resposta da API (timeout 15s)
    await page.waitForTimeout(2000);

    // Verificar se c√≥digo de 8 d√≠gitos apareceu OU mensagem de status de conex√£o
    const codeVisible = await page.getByText(/\d{8}/).isVisible({ timeout: 5000 }).catch(() => false);
    const statusVisible = await page.getByText(/conectando|aguardando|digite.*c√≥digo/i).isVisible({ timeout: 5000 }).catch(() => false);

    expect(codeVisible || statusVisible).toBeTruthy();
  });

  test('QR Code: submeter formul√°rio deve exibir QR Code ou loading', async ({ page }) => {
    // Selecionar QR Code
    await page.getByRole('button', { name: /qr code/i }).click();

    // Clicar em gerar QR Code
    await page.getByRole('button', { name: /gerar|continuar|pr√≥ximo/i }).click();

    // Aguardar resposta
    await page.waitForTimeout(2000);

    // Verificar se QR Code apareceu (imagem) OU loading OU mensagem de status
    const qrImage = await page.locator('img[alt*="qr"], canvas, svg').isVisible({ timeout: 5000 }).catch(() => false);
    const loadingVisible = await page.getByText(/gerando|carregando|aguarde/i).isVisible({ timeout: 5000 }).catch(() => false);
    const statusVisible = await page.getByText(/conectando|escaneie/i).isVisible({ timeout: 5000 }).catch(() => false);

    expect(qrImage || loadingVisible || statusVisible).toBeTruthy();
  });

  test('Instru√ß√£o deve mudar conforme m√©todo selecionado', async ({ page }) => {
    // Pairing Code selecionado (padr√£o)
    await expect(page.getByText(/c√≥digo.*8 d√≠gitos/i)).toBeVisible();

    // Alternar para QR Code
    await page.getByRole('button', { name: /qr code/i }).click();

    // Instru√ß√£o deve mudar para QR Code
    await expect(page.getByText(/escanear.*c√¢mera/i)).toBeVisible();
  });

  test('Status de conex√£o deve ser vis√≠vel ap√≥s submeter', async ({ page }) => {
    // Usar QR Code (mais simples para teste sem n√∫mero real)
    await page.getByRole('button', { name: /qr code/i }).click();
    await page.getByRole('button', { name: /gerar|continuar|pr√≥ximo/i }).click();

    // Aguardar e verificar status
    await page.waitForTimeout(2000);

    // Deve mostrar algum status (conectando, aguardando, erro, etc)
    const hasStatus = await page.getByText(/status|conectando|aguardando|erro|sucesso/i).isVisible({ timeout: 5000 }).catch(() => false);

    // Ou pode ter redirecionado para tela de sucesso
    const isSuccessScreen = await page.getByText(/conectado|sucesso|pronto/i).isVisible({ timeout: 5000 }).catch(() => false);

    expect(hasStatus || isSuccessScreen).toBeTruthy();
  });

  test('Voltar do wizard deve ser poss√≠vel', async ({ page }) => {
    // Verificar se h√° bot√£o de voltar/cancelar
    const backButton = page.getByRole('button', { name: /voltar|cancelar/i });

    if (await backButton.isVisible({ timeout: 2000 })) {
      await backButton.click();

      // Verificar que ainda est√° na p√°gina de WhatsApp ou voltou ao dashboard
      const currentUrl = page.url();
      expect(currentUrl).toMatch(/whatsapp|dashboard/);
    }
  });
});

test.describe('WhatsApp Connection - Edge Cases', () => {
  test.beforeEach(async ({ page }) => {
    // Login e navegar para WhatsApp
    await page.goto('https://oxy-frontend-d84c.onrender.com/login');
    await page.getByRole('textbox', { name: /email/i }).fill('test@petshop.com');
    await page.getByRole('textbox', { name: /senha/i }).fill('Test@123');
    await page.getByRole('button', { name: /entrar/i }).click();
    await page.waitForURL(/.*\/dashboard/, { timeout: 10000 });
    await page.goto('https://oxy-frontend-d84c.onrender.com/whatsapp');
    await page.waitForLoadState('networkidle');
  });

  test('N√∫mero de telefone com formato inv√°lido deve mostrar erro', async ({ page }) => {
    await page.getByRole('button', { name: /pairing code/i }).click();

    // Tentar com n√∫mero muito curto
    const phoneInput = page.locator('input[placeholder*="n√∫mero"]').or(page.getByRole('textbox').filter({ hasText: /whatsapp/i }));
    await phoneInput.fill('123');
    await page.getByRole('button', { name: /gerar|continuar|pr√≥ximo/i }).click();

    // Deve mostrar erro de valida√ß√£o
    await expect(page.getByText(/inv√°lido|formato|n√∫mero/i)).toBeVisible({ timeout: 3000 });
  });

  test('Altern√¢ncia r√°pida entre m√©todos n√£o deve causar erro', async ({ page }) => {
    // Alternar rapidamente entre os dois m√©todos
    for (let i = 0; i < 3; i++) {
      await page.getByRole('button', { name: /qr code/i }).click();
      await page.waitForTimeout(100);
      await page.getByRole('button', { name: /pairing code/i }).click();
      await page.waitForTimeout(100);
    }

    // N√£o deve ter erros no console ou na UI
    const errors = await page.locator('text=/erro|error/i').count();
    expect(errors).toBe(0);
  });

  test('Recarregar p√°gina durante conex√£o deve manter estado', async ({ page }) => {
    // Iniciar conex√£o com QR Code
    await page.getByRole('button', { name: /qr code/i }).click();
    await page.getByRole('button', { name: /gerar|continuar|pr√≥ximo/i }).click();
    await page.waitForTimeout(2000);

    // Recarregar p√°gina
    await page.reload();

    // Verificar que ainda est√° na p√°gina de WhatsApp
    await expect(page).toHaveURL(/.*\/whatsapp/);
  });
});
